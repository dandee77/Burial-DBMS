<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy a Plan</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', path='css/dashboard_sidebar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='css/client_buyaplan.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="sidebar"> 
        <div class="logo"></div>
        <ul class="menu">
           <li>
               <a href="/dashboard">
                   <i class="fas fa-dashboard"></i>
                   <span>Dashboard</span>
               </a>
           </li>
           <li>
               <a href="/dashboard/vicinity_map">
                   <i class="fas fa-map"></i>
                   <span>Vicinity Map</span>
               </a>
           </li>
           <li class = "active"> 
               <a href="/dashboard/contact_us">
                   <i class="fas fa-phone-square"></i>
                   <span>Contact Us</span>
               </a>
           </li>
           <li>
               <a href="/dashboard/buyaplan">
                   <i class="fas fa-shopping-cart"></i>
                   <span>Buy a Plan</span>
               </a>
           </li>
           <li>
               <a href="/dashboard/payment">
                   <i class="fas fa-tag"></i>
                   <span>Payments</span>
               </a>
           </li>
           <li>
               <a href="#">
                   <i class="fas fa-clipboard"></i>
                   <span>Contract</span>
               </a>
           </li>
           <li>
               <a href="#">
                   <i class="fas fa-gear"></i>
                   <span>Maintenance</span>
               </a>
           <li>
               <a href="#">
                   <i class="fas fa-address-card"></i>
                   <span>Profile</span>
               </a>
           </li>
           </li>
           <li class = "logout">
               <a href="/">
                   <i class="fas fa-sign-out-alt"></i>
                   <span>Logout</span>
               </a>
           </li>
        </ul>
   </div>

<div class="container">
  <h1 class="page-title">Buy a Burial Plan</h1>

  <div class="form-section">
    <form id="planForm">
      <label for="slotSelect">Select Available Slot:</label>
      <input list="slots" id="slotSelect" name="slot_id" placeholder="Type to search...">
      <datalist id="slots"></datalist>

      <label for="paymentMethod">Payment Method:</label>
      <select id="paymentMethod" name="payment_method">
        <option value="cash">Cash</option>
        <option value="online">Online</option>
        <option value="bank_transfer">Bank Transfer</option>
      </select>

      <label for="yearsToPay">Years to Pay:</label>
      <select id="yearsToPay" name="years_to_pay">
        <option value="0">Full Payment</option>
        <option value="36">3 Years</option>
        <option value="60">5 Years</option>
        <option value="120">10 Years</option>
      </select>

      <button type="submit" class="btn-submit">Submit Purchase</button>
    </form>
  </div>

  <div class="details-section">
    <h2>Contract Summary</h2>
    <table id="summaryTable">
      <tbody>
        <tr><td>Contract Price:</td><td id="contractPrice">-</td></tr>
        <tr><td>VAT (12%):</td><td id="vatAmount">-</td></tr>
        <tr><td>Price with VAT:</td><td id="priceWithVAT">-</td></tr>
        <tr><td>Admin Fee:</td><td id="adminFee">-</td></tr>
        <tr><td>Spot Cash Total:</td><td id="spotCashTotal">-</td></tr>
        <tr><td>Down Payment (20%):</td><td id="downPayment">-</td></tr>
        <tr><td>Interest Rate:</td><td id="interestRate">-</td></tr>
        <tr><td>Monthly Amortization:</td><td id="monthlyAmortization">-</td></tr>
        <tr><td>Final Price:</td><td id="finalPrice">-</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const clientId = 3; // Replace with dynamic session value in production
  const slotInput = document.getElementById('slotSelect');
  const slotList = document.getElementById('slots');
  const paymentMethod = document.getElementById('paymentMethod');
  const yearsToPay = document.getElementById('yearsToPay');

  let selectedSlot = null;
  let slotData = [];

  async function fetchAvailableSlots() {
    const response = await fetch('/api/available_slots');
    slotData = await response.json();

    slotList.innerHTML = '';
    slotData.forEach(slot => {
      const option = document.createElement('option');
      option.value = `Slot ${slot.slot_id} (${slot.slot_type})`;
      option.dataset.id = slot.slot_id;
      slotList.appendChild(option);
    });
  }

  function calculate() {
    if (!selectedSlot) return;
    const slotType = selectedSlot.slot_type;
    const basePrice = slotType === 'plot' ? 300000 : 10000000;
    const vat = basePrice * 0.12;
    const priceWithVAT = basePrice + vat;
    const adminFee = slotType === 'plot' ? 5000 : 25000;
    const spotCashTotal = priceWithVAT + adminFee;
    const downPayment = priceWithVAT * 0.2;

    let interestRate = 0;
    let amortization = 0;
    let years = parseInt(yearsToPay.value);

    if (years === 60) interestRate = 0.00525;
    else if (years === 120) interestRate = 0.00623;
    else if (years === 36) interestRate = 0.0034286;

    if (years > 0) {
      const principal = priceWithVAT - downPayment;
      amortization = principal * ((interestRate * Math.pow(1 + interestRate, years - 1)) / (Math.pow(1 + interestRate, years - 1) - 1));
    }

    const finalPrice = years > 0 ? downPayment + (amortization * (years - 1)) : spotCashTotal;

    document.getElementById('contractPrice').textContent = `₱${basePrice.toLocaleString()}`;
    document.getElementById('vatAmount').textContent = `₱${vat.toLocaleString()}`;
    document.getElementById('priceWithVAT').textContent = `₱${priceWithVAT.toLocaleString()}`;
    document.getElementById('adminFee').textContent = `₱${adminFee.toLocaleString()}`;
    document.getElementById('spotCashTotal').textContent = `₱${spotCashTotal.toLocaleString()}`;
    document.getElementById('downPayment').textContent = `₱${downPayment.toLocaleString()}`;
    document.getElementById('interestRate').textContent = interestRate > 0 ? `${(interestRate * 100).toFixed(2)}%` : '-';
    document.getElementById('monthlyAmortization').textContent = amortization > 0 ? `₱${amortization.toFixed(2)}` : '-';
    document.getElementById('finalPrice').textContent = `₱${finalPrice.toLocaleString()}`;
  }

  slotInput.addEventListener('input', () => {
    const match = slotData.find(s => slotInput.value.includes(s.slot_id));
    selectedSlot = match;
    calculate();
  });

  yearsToPay.addEventListener('change', calculate);
  paymentMethod.addEventListener('change', calculate);

  document.getElementById('planForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!selectedSlot) return alert('Please select a valid slot.');

    const payload = {
      slot_id: selectedSlot.slot_id,
      client_id: clientId,
      years_to_pay: parseInt(yearsToPay.value),
      payment_method: paymentMethod.value
    };

    const res = await fetch('/api/contracts/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (res.ok) alert('Contract successfully created!');
    else alert('Failed to create contract: ' + data.message);
  });

  fetchAvailableSlots();
</script>
</body>
</html>