<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', path='css/dashboard_sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/client_payment.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="sidebar"> 
        <div class="logo"></div>
        <ul class="menu">
           <li>
               <a href="/dashboard">
                   <i class="fas fa-dashboard"></i>
                   <span>Dashboard</span>
               </a>
           </li>
           <li>
               <a href="/dashboard/vicinity_map">
                   <i class="fas fa-map"></i>
                   <span>Vicinity Map</span>
               </a>
           </li>
           <li>
               <a href="/dashboard/contact_us">
                   <i class="fas fa-phone-square"></i>
                   <span>Contact Us</span>
               </a>
           </li>
           <li>
               <a href="/dashboard/buyaplan">
                   <i class="fas fa-shopping-cart"></i>
                   <span>Buy a Plan</span>
               </a>
           </li>
           <li class="active">
               <a href="/dashboard/payment">
                   <i class="fas fa-tag"></i>
                   <span>Payments</span>
               </a>
           </li>
           <li>
               <a href="#">
                   <i class="fas fa-clipboard"></i>
                   <span>Contract</span>
               </a>
           </li>
           <li>
               <a href="#">
                   <i class="fas fa-gear"></i>
                   <span>Maintenance</span>
               </a>
           <li>
               <a href="#">
                   <i class="fas fa-address-card"></i>
                   <span>Profile</span>
               </a>
           </li>
           </li>
           <li class="logout">
               <a href="/">
                   <i class="fas fa-sign-out-alt"></i>
                   <span>Logout</span>
               </a>
           </li>
        </ul>
   </div>
   
   <div class="container">
    <h1 class="page-title">Your Payment Plans</h1>
    
    <div id="contracts-container">
        <div class="loading-message">
            <i class="fas fa-spinner fa-spin"></i> Loading your contracts...
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const clientId = 3; // Replace with actual client ID from session
        
        fetch(`/api/contracts/client/${clientId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const container = document.getElementById('contracts-container');
                
                // First check if data is an array or object with contracts property
                const contracts = Array.isArray(data) ? data : (data.contracts || []);
                
                if (!contracts || contracts.length === 0) {
                    container.innerHTML = `
                        <div class="no-contracts">
                            <i class="fas fa-info-circle"></i>
                            <p>You don't have any active contracts yet.</p>
                            <a href="/dashboard/buyaplan" class="btn-buy-plan">Buy a Plan</a>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                contracts.forEach(contract => {
                    // Ensure we have the required fields
                    if (!contract.order_id || !contract.slot_type) {
                        console.warn('Invalid contract data:', contract);
                        return;
                    }

                    const contractElement = document.createElement('div');
                    contractElement.className = 'contract-card';
                    contractElement.dataset.expanded = 'false';
                    
                    const paymentStatus = contract.is_paid ? 
                        '<span class="status-badge paid">PAID</span>' : 
                        '<span class="status-badge unpaid">UNPAID</span>';
                    
                    // Format dates safely
                    const orderDate = contract.order_date ? 
                        new Date(contract.order_date).toLocaleDateString() : 'N/A';
                    const lastPaymentDate = contract.latest_payment_date ? 
                        new Date(contract.latest_payment_date).toLocaleDateString() : 'N/A';
                    
                    // Ensure numerical values are properly formatted
                    const formatCurrency = (value) => {
                        return value ? 
                            `₱${parseFloat(value).toLocaleString('en-US', {minimumFractionDigits: 2})}` : 
                            '₱0.00';
                    };

                    contractElement.innerHTML = `
                        <div class="contract-summary">
                            <div class="summary-header">
                                <h3>Contract #${contract.order_id}</h3>
                                ${paymentStatus}
                            </div>
                            
                            <div class="summary-details">
                                <div class="detail-row">
                                    <span class="detail-label">Slot ID:</span>
                                    <span class="detail-value">${contract.slot_id ? contract.slot_id : 'N/A'}</span>
                                </div>
                                
                                <div class="detail-row">
                                    <span class="detail-label">Total Amount:</span>
                                    <span class="detail-value">${formatCurrency(contract.final_price)}</span>
                                </div>
                                
                                ${contract.monthly_amortization > 0 ? `
                                <div class="detail-row">
                                    <span class="detail-label">Monthly Payment:</span>
                                    <span class="detail-value">${formatCurrency(contract.monthly_amortization)}</span>
                                </div>
                                
                                <div class="detail-row">
                                    <span class="detail-label">Remaining Term:</span>
                                    <span class="detail-value">${contract.years_to_pay || 0} months</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="contract-full-details" style="display: none;">
                            <div class="details-grid">
                                <div class="detail-group">
                                    <h4>Contract Information</h4>
                                    <div class="detail-row">
                                        <span class="detail-label">Order Date:</span>
                                        <span class="detail-value">${orderDate}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Contract Price:</span>
                                        <span class="detail-value">${formatCurrency(contract.contract_price)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">VAT (${contract.vat_percent || 0}%):</span>
                                        <span class="detail-value">${formatCurrency(contract.vat_amount)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Price with VAT:</span>
                                        <span class="detail-value">${formatCurrency(contract.price_with_vat)}</span>
                                    </div>
                                </div>
                                
                                <div class="detail-group">
                                    <h4>Payment Details</h4>
                                    <div class="detail-row">
                                        <span class="detail-label">Payment Method:</span>
                                        <span class="detail-value">${contract.payment_method ? contract.payment_method.toUpperCase() : 'N/A'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Admin Fee:</span>
                                        <span class="detail-value">${formatCurrency(contract.admin_fee)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Spot Cash Total:</span>
                                        <span class="detail-value">${formatCurrency(contract.spot_cash_total)}</span>
                                    </div>
                                    ${contract.latest_payment_date ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Last Payment:</span>
                                        <span class="detail-value">${lastPaymentDate}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                ${contract.monthly_amortization > 0 ? `
                                <div class="detail-group">
                                    <h4>Installment Plan</h4>
                                    <div class="detail-row">
                                        <span class="detail-label">Interest Rate:</span>
                                        <span class="detail-value">${contract.interest_rate ? (parseFloat(contract.interest_rate) * 100).toFixed(2) : '0.00'}%</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Down Payment:</span>
                                        <span class="detail-value">${formatCurrency(contract.down_payment)}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="contract-actions">
                            <button class="btn-pay-now" ${contract.is_paid ? 'disabled' : ''}>
                                <i class="fas fa-credit-card"></i> Pay Now
                            </button>
                            <button class="btn-view-details">
                                <i class="fas fa-chevron-down"></i> View Details
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(contractElement);
                });

                // Add event listeners for view details buttons
                document.querySelectorAll('.btn-view-details').forEach(button => {
                    button.addEventListener('click', function() {
                        const card = this.closest('.contract-card');
                        const isExpanded = card.dataset.expanded === 'true';
                        const detailsSection = card.querySelector('.contract-full-details');
                        const icon = this.querySelector('i');
                        
                        if (isExpanded) {
                            detailsSection.style.display = 'none';
                            icon.className = 'fas fa-chevron-down';
                            this.innerHTML = '<i class="fas fa-chevron-down"></i> View Details';
                        } else {
                            detailsSection.style.display = 'block';
                            icon.className = 'fas fa-chevron-up';
                            this.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Details';
                        }
                        
                        card.dataset.expanded = !isExpanded;
                    });
                });
            })
            .catch(error => {
                console.error('Error fetching contracts:', error);
                document.getElementById('contracts-container').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load your contracts. Please try again later.</p>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            });
    });
</script>
</body>
</html>